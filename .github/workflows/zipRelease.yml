name: Build ZIP on Tag Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-zip:
    runs-on: ubuntu-latest
    env:
      BUILD_OUTPUT: VelaDocsCopier-${{ format('{0}', github.ref_name) }}.zip
      VERSION: ${{ format('{0}', github.ref_name) }}
      TEMP_DIR: ${{ github.workspace }}/.temp_build

    steps:
      # 1. ä»£ç æ£€å‡ºï¼ˆä¿ç•™å®Œæ•´gitå†å²ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ä½¿ç”¨ rsync å‡†å¤‡æ‰“åŒ…ç›®å½•ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
      - name: Prepare build directory
        run: |
          mkdir -p "$TEMP_DIR"
          rsync -r --exclude='README.md' --exclude='.DS_Store' --exclude='.git' \
            icons/ manifest.json src/ "$TEMP_DIR/"

      # 3. æ‰“åŒ…ä¸º ZIP
      - name: Create ZIP archive
        run: |
          cd "$TEMP_DIR" && zip -r "../${BUILD_OUTPUT}" .
          echo "Built ZIP: ${BUILD_OUTPUT}"

      # 4. ç²¾ç¡®åŒ¹é…çš„æ›´æ–°æ—¥å¿—ç”Ÿæˆï¼ˆä¸åŸ Action ä¿æŒä¸€è‡´ï¼‰
      - name: Generate precise changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªreleaseçš„tag
          PREV_RELEASE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/ ${{ github.repository }}/releases/latest" | \
            jq -r '.tag_name // empty')

          # ç”Ÿæˆç²¾ç¡®æ ¼å¼çš„æ—¥å¿—
          CHANGELOG_TITLE="## ğŸ“ æ›´æ–°æ—¥å¿— ${PREV_RELEASE:-åˆå§‹ç‰ˆæœ¬} â†’ ${{ github.ref_name }}"
          CHANGELOG_BODY=$(git log --pretty=format:"- **%s**%n  è´¡çŒ®è€…ï¼š%an <%ae>%n  æäº¤æ—¶é—´ï¼š%ad%n  %b" \
            --date=format:"%Y-%m-%d %H:%M:%S" \
            ${PREV_RELEASE:+$PREV_RELEASE..}${{ github.ref_name }} | \
            sed '/^  $/d' | \
            sed 's/^  $$BUG$$/[BUG]/')

          echo "CHANGELOG_TITLE=${CHANGELOG_TITLE}" >> "$GITHUB_ENV"
          echo "CHANGELOG_BODY=${CHANGELOG_BODY}" >> "$GITHUB_ENV"

      # 5. è·å–æ„å»ºå…ƒæ•°æ®
      - name: Gather metadata
        id: meta
        run: |
          # æ„å»ºæ—¶é—´ï¼ˆUTC+8ï¼‰
          echo "time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> "$GITHUB_OUTPUT"

          # ç­¾åçŠ¶æ€ï¼ˆæ­¤å¤„ä¸ºæ’ä»¶ï¼Œä¸ç­¾åï¼‰
          echo "sign_status=æ— ç­¾åéœ€æ±‚" >> "$GITHUB_OUTPUT"

          # è·å–commitçŸ­ID
          echo "short_sha=$(git rev-parse --short "${{ github.sha }}")" >> "$GITHUB_OUTPUT"

      # 6. åˆ›å»ºæ ¼å¼åŒ–çš„ GitHub Release
      - name: Create Formatted Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: ğŸ‰ Release ${{ github.ref_name }}
          body: |
            ${{ env.CHANGELOG_TITLE }}
            ${{ env.CHANGELOG_BODY }}

            ## ğŸ› ï¸ æ„å»ºä¿¡æ¯
            - ğŸ•’ æ„å»ºæ—¶é—´: ${{ steps.meta.outputs.time }} (UTC+8)
            - ğŸ·ï¸ æ ‡ç­¾: ${{ github.ref_name }}
            - ğŸ”— æäº¤: [${{ steps.meta.outputs.short_sha }}](https://github.com/ ${{ github.repository }}/commit/${{ github.sha }})
            - ğŸ” ç­¾åçŠ¶æ€: ${{ steps.meta.outputs.sign_status }}
            - ğŸ“¦ æ„å»ºäº§ç‰©: ${{ env.BUILD_OUTPUT }}
          files: ${{ env.BUILD_OUTPUT }}
          draft: false
          prerelease: false